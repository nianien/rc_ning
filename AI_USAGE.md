# AI 使用说明（AI-empowered, not AI-dependent）

## 1. 使用定位与基本原则

在本项目中，AI 被用于辅助工程设计与实现推进，其角色定位为能力增强工具（AI-empowered），而非工程判断或决策主体（AI-dependent）。在使用过程中，参考了 Claude Skill 的能力模式，通过明确的指令约束和专业化引导，提升 AI 在特定工程任务上的输出质量。

整体使用原则是：
由人定义方向、边界、约束与验证标准；AI 在明确约束下提供参考方案与实现支持。

所有关键工程决策均由人基于业务目标和工程经验完成，并通过可观测、可回溯的机制进行验证。

---

## 2. 人与 AI 的职责边界

### 2.1 人的职责（Decision & Control）
- 定义问题背景与系统目标
- 明确系统边界（IN / OUT of scope）
- 确定可靠性语义与失败处理策略
- 约束复杂度、成本与演进路径
- 制定验收与验证标准（SLO、监控、日志、可回溯性）

### 2.2 AI 的职责（Reference & Execution Support）
- 在既定约束下生成候选设计方案
- 提供实现骨架与模块拆分建议
- 辅助补全边界条件、异常路径与遗漏检查
- 加速基础代码与样板结构的落地

---

## 3. 约束 AI 输出的核心工程原则

AI 的所有产出均需符合以下工程原则，这些原则同时也是本系统设计的核心目标：

- **通用性（Generality）**
  系统定位为可靠 HTTP 通知投递层，不引入业务语义，不承担幂等、字段映射或流程编排职责。
- **扩展性（Extensibility）**
  关键能力通过接口与模块边界隔离（如 Queue、Retry、Delivery），支持后续在不重构主流程的情况下演进。
- **稳定性（Stability）**
  选择 At-Least-Once 投递语义，允许重复但不丢失；复杂一致性问题明确排除在第一版范围之外。
- **可观测性（Observability）**
  投递状态、失败原因、延迟分布和队列积压必须可观测，作为系统的一等能力。
- **可回溯性（Traceability）**
  每一次投递尝试都必须可复盘，支持问题定位与事后审计。

---

## 4. 实际使用过程中出现并被纠正的典型偏差

在实际使用 AI 生成设计与实现过程中，出现过若干与工程目标不匹配的产出，这些偏差均被人工识别并纠正，最终方案得以收敛。

### Case 1：过度追求一致性，越界承担业务语义

**AI 初始产出**
倾向在通知系统内部实现请求去重与 exactly-once 语义。

**问题识别**
- 引入业务语义判断
- 显著增加状态复杂度
- 无法在通用场景下成立

**纠正与结果**
- 明确系统边界仅负责可靠投递
- 采用 At-Least-Once 语义
- 幂等性由外部系统承担

---

### Case 2：第一版引入重型基础设施

**AI 初始产出**
默认推荐 Kafka + 多 Topic 路由方案。

**问题识别**
- 运维成本与当前规模不匹配
- 复杂度收益比不成立

**纠正与结果**
- 第一版采用 Redis + Worker
- 数据库作为 Source of Truth 兜底
- 通过接口预留升级空间

---

### Case 3：失败处理策略过于复杂

**AI 初始产出**
建议实现复杂的失败分类策略，对不同HTTP状态码采用不同的重试逻辑（如4xx不重试、5xx重试、特定状态码特殊处理等）。

**问题识别**
- MVP阶段过度设计
- 增加代码复杂度
- 实际场景中大多数失败都值得重试

**纠正与结果**
- 采用统一的重试策略：所有失败均进行重试，直到达到最大重试次数
- 通过投递日志记录每次尝试的HTTP状态码、错误信息和延迟
- 为后续版本预留扩展空间（可基于日志数据分析后再优化策略）

---

### Case 4：忽略投递过程的可回溯性

**AI 初始产出**
仅记录最终任务状态。

**问题识别**
- 无法定位失败发生阶段
- 不支持事后复盘与审计

**纠正与结果**
- 引入独立投递日志
- 记录每次 attempt 的状态、错误与延迟
- 建立完整审计链路

---

### Case 5：模块职责耦合，影响演进

**AI 初始产出**
将 HTTP 投递、重试、状态更新混合在单一执行逻辑中。

**问题识别**
- 扩展成本高
- 测试与替换困难

**纠正与结果**
- 拆分为独立能力模块
- Worker 仅负责流程编排
- 为熔断、批量等能力预留空间

---

## 5. AI 在实现阶段的使用方式

在实现阶段，AI 的使用集中在以下可控范围内：

- **模块化拆分**
  生成 API / Worker / Common 的基础结构与样板代码，确保边界清晰。
- **扩展点接口化**
  输出 Queue、Retry、Delivery 等接口定义与默认实现，支持后续替换。
- **可靠性与恢复脚手架**
  辅助生成重试、退避、卡住任务扫描等基础逻辑，由人工校验边界。
- **可观测性补全**
  辅助补齐日志字段、指标与告警规则草案，最终以排障能力为验收标准。

---

## 6. 决策归属与验证闭环

本项目中所有关键决策均由人负责，并通过以下方式验证其正确性：
- 所有异常均可通过任务状态 + 投递日志还原
- 策略调整需通过指标验证其收益与副作用
- 系统行为可解释、可回放、可审计

---

## 总结

AI 在本项目中被用于加速而非替代工程判断。
通过明确边界、持续纠偏与结果验证，最终方案在通用性、扩展性、稳定性、可观测性与可回溯性之间达成了可控平衡。
